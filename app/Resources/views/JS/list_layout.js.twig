<script type="text/javascript">

    /**
     *
     * @type {Boolean}
     * @private
     */
    var field_dialog_{{ id }} = false;

    /**
     *
     * @type {*}
     */
    var symfony_ajax = symfony_ajax || {'behaviors': {}};

    /**
     *
     * @param context
     */
    symfony_attach_behaviors{{ id }} = function (context) {
        context = context || document;
        $.each(symfony_ajax.behaviors, function () {
            if ($.isFunction(this.attach)) {
                this.attach(context);
            }
        });
    };

    /**
     *
     * @return {*}
     */
    symfony_ajax.get_uniqid = function(){

        var _uniqid = null;
        var client_id_name = $('.client_id').attr('name');

        if (client_id_name) {
            _uniqid = client_id_name.replace('[client_id]', '');
        }
        return _uniqid;
    }

    /**
     *
     * @private
     */
    function initialize_popup_{{ id }}() {
            // initialize component
            if (!field_dialog_{{ id }}) {
                field_dialog_{{ id }} = jQuery("#field_dialog_{{ id }}");

            // move the dialog as a child of the root element, nested form breaks html ...
            jQuery(document.body).append(field_dialog_{{ id }});

            Admin.log('[{{ id }}|field_dialog] move dialog container as a document child');
        }
    }

    // handle the add link
    var field_dialog_form_add_{{ id }} = function (event, link, options) {
        options = options || {};
        options = $.extend({
            title : ''
        }, options);

        $('#popup_form_title').html(options.title);

        event.preventDefault();
        event.stopPropagation();

        var a = jQuery(this);

        field_dialog_{{ id }}.find('.popup-body').html('');

        Admin.log('[{{ id }}|field_dialog_form_add] add link action');

        // retrieve the form element from the related admin generator
        jQuery.ajax({
            url:link,
            dataType:'html',
            success:function (html) {

                Admin.log('[{{ id }}|field_dialog_form_add] ajax success', field_dialog_{{ id }});

                field_dialog_form_content_{{ id }}(html);

                field_dialog_{{ id }}.modal('toggle');
            }
        });
    };

    var field_dialog_form_content_{{ id }} = function (html) {
        // populate the popup container
        field_dialog_{{ id }}.find('.popup-body').html(html);


        jQuery('.sonata-actions', field_dialog_{{ id }}).parent().remove();
        var dialog_title = jQuery('.popup-body legend', field_dialog_{{ id }}).text();
        jQuery('.popup-body legend', field_dialog_{{ id }}).remove();

        if(dialog_title==''){
            dialog_title = jQuery('.popup-body h1', field_dialog_{{ id }}).text();
            jQuery('.popup-body h1', field_dialog_{{ id }}).remove();
        }

        field_dialog_{{ id }}.find('#title').html(dialog_title);

        jQuery('.datepicker').datepicker({language:'{{default_locale}}', format: '{{default_date_format_js}}'});

        // capture the submit event to make an ajax call, ie : POST data to the
        // related create admin
        jQuery('a', field_dialog_{{ id }}).die().live('click', field_dialog_form_action_{{ id }});
        jQuery('form', field_dialog_{{ id }}).die().live('submit', field_dialog_form_action_{{ id }});

        symfony_attach_behaviors{{ id }}( field_dialog_{{ id }}.find('.popup-body'));
    };

    // handle the post data
    var field_dialog_form_action_{{ id }} = function (event) {

        event.preventDefault();
        event.stopPropagation();

        Admin.log('[{{ id }}|field_dialog_form_action] action catch', this);

        initialize_popup_{{ id }}();

        var element = jQuery(this);

        var url;
        var type;

        if (this.nodeName == 'FORM') {
            url = element.attr('action');
            type = element.attr('method');
        } else if (this.nodeName == 'A') {
            url = element.attr('href');
            type = 'GET';
        } else {
            alert('unexpected element : @' + this.nodeName + '@');
            return;
        }

        if (element.hasClass('sonata-ba-action')) {
            Admin.log('[{{ id }}|field_dialog_form_action] reserved action stop catch all events');
            return;
        }

        var data = {
            _xml_http_request:true
        };

        var form = jQuery(this);

        Admin.log('[{{ id }}|field_dialog_form_action] execute ajax call');

        // the ajax post
        jQuery(form).ajaxSubmit({
            url:url,
            type:type,
            data:data,
            success:function (data) {

                Admin.log('[{{ id }}|field_dialog_form_action] ajax success');

                if (typeof data == 'string') {
                    field_dialog_form_content_{{ id }}(data);
                    return;
                }

                // if the crud action return ok, then the element has been added
                // so the widget container must be refresh with the last option available
                if (data.result == 'ok') {
                    $(html_ajax_load()).show().appendTo('body');
                    field_dialog_{{ id }}.dialog('close');
                    window.location.reload();
                    return;
                }

                // otherwise, display form error
                field_dialog_form_content_{{ id }}(data);
                Admin.add_pretty_errors(field_dialog_{{ id }});

                // reattach the event
                jQuery('form', field_dialog_{{ id }}).submit(field_dialog_form_action_{{ id }});
            }
        });

        return false;
    };

    $(function(){
        initialize_popup_{{ id }}();
        symfony_attach_behaviors{{ id }}(document);
    })

</script>